<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Robotic Hand Mimic</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        #video-input { display: none; } 
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffcc; font-size: 24px; pointer-events: none; z-index: 10;
        }

        /* Top Header Text */
        .header-text {
            position: absolute; top: 20px; width: 100%; text-align: center;
            color: #00ffcc; font-size: 18px; font-weight: bold; letter-spacing: 2px;
            text-transform: uppercase; pointer-events: none; z-index: 5;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }

        /* Bottom Footer Text */
        .footer-text {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: rgba(255, 255, 255, 0.6); font-size: 14px; pointer-events: none; z-index: 5;
        }

        .instruction {
            position: absolute; bottom: 60px; left: 20px; color: white;
            background: rgba(0,0,0,0.6); padding: 10px 15px; border-radius: 8px;
            border: 1px solid rgba(0, 255, 204, 0.3); font-size: 14px; z-index: 5;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>

    <div id="loading">Loading AI Models... please allow camera access.</div>
    
    <div class="header-text">Advanced Hand Tracking Server</div>
    <div class="footer-text">Created by Soumyajyoti Konar | Powered by SomuAI</div>

    <div class="instruction">Show your hand to the camera to control the robot.</div>
    
    <div id="canvas-container"></div>
    <video id="video-input"></video>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.FogExp2(0x050505, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Lights
        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(0, 10, 10);
        light.castShadow = true;
        scene.add(light);
        
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);
        
        const rimLight = new THREE.PointLight(0x00ffff, 2, 20);
        rimLight.position.set(10, 5, -5);
        scene.add(rimLight);

        // --- 2. BUILD THE ROBOT HAND MODEL ---
        const jointMeshes = [];
        const boneMeshes = [];
        
        const jointMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xaaaaaa, roughness: 0.2, metalness: 0.8 
        });

        const boneMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x222222, roughness: 0.5, metalness: 0.5 
        });

        for (let i = 0; i < 21; i++) {
            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
            const sphere = new THREE.Mesh(geometry, jointMaterial);
            sphere.castShadow = true;
            scene.add(sphere);
            jointMeshes.push(sphere);
        }

        const connections = [
            [0, 1], [1, 2], [2, 3], [3, 4],
            [0, 5], [5, 6], [6, 7], [7, 8],
            [0, 9], [9, 10], [10, 11], [11, 12],
            [0, 13], [13, 14], [14, 15], [15, 16],
            [0, 17], [17, 18], [18, 19], [19, 20],
            [5, 9], [9, 13], [13, 17]
        ];

        for (let i = 0; i < connections.length; i++) {
            const geometry = new THREE.CylinderGeometry(0.25, 0.25, 1, 8);
            geometry.translate(0, 0.5, 0); 
            geometry.rotateX(Math.PI / 2);
            const cylinder = new THREE.Mesh(geometry, boneMaterial);
            cylinder.castShadow = true;
            scene.add(cylinder);
            boneMeshes.push({ mesh: cylinder, from: connections[i][0], to: connections[i][1] });
        }

        // --- 3. MEDIAPIPE SETUP ---
        const videoElement = document.getElementById('video-input');

        function onResults(results) {
            document.getElementById('loading').style.display = 'none';
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                for (let i = 0; i < landmarks.length; i++) {
                    const lm = landmarks[i];
                    const x = (0.5 - lm.x) * 22; 
                    const y = (0.5 - lm.y) * 22;
                    const z = -lm.z * 20; 
                    jointMeshes[i].position.set(x, y, z);
                }
                boneMeshes.forEach(bone => {
                    const p1 = jointMeshes[bone.from].position;
                    const p2 = jointMeshes[bone.to].position;
                    bone.mesh.position.copy(p1);
                    bone.mesh.scale.z = p1.distanceTo(p2);
                    bone.mesh.lookAt(p2);
                });
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        });
        cameraUtils.start();

        // --- 4. RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>